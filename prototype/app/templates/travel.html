{% extends "base.html" %}

{% block css %}
<link rel = "stylesheet" href = "{{ url_for('static', filename = 'css/travel.css') }}">
{% endblock%}

{% block main %}
<h1 class="page-header">HACKATHON - OMNI-Dev - Travel</h1>
{% include 'flash_messages.html' %}

<div class ="container">
<p class="lead">Prototype of our application</p>
<h2 id = "text-center"> Enter your destination:</h2>
<form id = "destination-form">
    <input type = "text" id = "destination-input" class = "form-control form-control-lg">
    <br>
    <button type = "submit" class = "btn btn-primary btn-block">GO!</button>
</form>
<br>
<div id = "map"></div>



<div id = "formatted-address" class = "card-block"></div>

<h3 id = "name-address" class = "card-block"><h3>

<div id = "address-components" class = "card-block"></div>

<!--<div id = "geometry" class = "card-block"></div> -->
</div>


{% endblock %}

{% block js%}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    hasCurrentLocation =false;
    function initMap(){
        var options = {
            zoom:13,
            center:{lat:18.0120,lng:-76.7987}
        }

        // new map

        var map = new google.maps.Map(document.getElementById('map'),options);
        
        
        // listen for clicks on map
        google.maps.event.addListener(map,'click',
        function(event){
            // add marker
            addMarker({coords:event.latLng});

        });
        //*/
        /*
        // add marker
        var marker = new google.maps.Marker({
            position:{lat:18.0120,lng:-76.7987},
            map:map,
            icon: //img url
        });

        // content on marker
        var infoWindow = new google.maps.InfoWindow({
            content: '<h3> HWT Bus Center </h3>'
        });

        // event listener for content

        marker.addListener('click', function(){
            infoWindow.open(map,marker);
        });

        */

         

        /*
        addMarker({coords:{lat:18.0120,lng:-76.7987},content:"'<h3> HWT Bus Center </h3>'"});

        addMarker({coords:{lat:18.003226513663353,lng:-76.78834332273956},content:"'<h3> The Jamaica Pegasus Hotel </h3>'"});
        */

        // Arrays for markers
        var markers = [
        {coords:{lat:18.0120,lng:-76.7987},content:"'<h3> HWT Bus Center </h3>'"},
        //{coords:{lat:18.003226513663353,lng:-76.78834332273956},content:"'<h3> The Jamaica Pegasus Hotel </h3>'"}
         ]

        // Loop through marker

        for(var i = 0; i < markers.length; i ++){
            addMarker(markers[i]);

        }; 


       // Add Marker Function 
       function addMarker(params){
            var marker = new google.maps.Marker({
                position:params.coords,
                map:map
            });

            if(params.content){
                // content on marker
                var infoWindow = new google.maps.InfoWindow({
                    content: params.content
                });

                // event listener for content

                marker.addListener('click', function(){
                    infoWindow.open(map,marker);
                });

            }
       }

        // current location

        if (!hasCurrentLocation){

            infoWindow = new google.maps.InfoWindow();
            const locationButton = document.createElement("button");
            locationButton.textContent = "Pan to Current Location";
            locationButton.classList.add("custom-map-control-button");
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            locationButton.addEventListener("click", () => {
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                    hasCurrentLocation = true;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    infoWindow.setPosition(pos);
                    infoWindow.setContent("Location found.");
                    infoWindow.open(map);
                    map.setCenter(pos);
                    },
                    () => {
                    handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
                } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
                }
            });
            }

            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                ? "Error: The Geolocation service failed."
                : "Error: Your browser doesn't support geolocation."
            );

            }

        

        
       



       
    

        //Call geocode
        //geocode();

        var destinationForm = document.getElementById("destination-form");


        //listen for submit
        destinationForm.addEventListener('submit',geocode);


        function geocode(e){
            e.preventDefault();

            var destination = document.getElementById("destination-input").value;

            if(destination === ""){
                alert("Please enter your destination");

            }else{

            

                if((!destination.includes("jamaica")) || (!destination.includes("Jamaica"))){
                    destination += " Jamaica";
                }
                axios.get("https://maps.googleapis.com/maps/api/geocode/json",{
                    params:{
                        address:destination,
                        key:'AIzaSyAsU1flb8aRtQ5GHugB5iH_A-ggXVR_EwA'
                    }
                })
                .then(function(response){
                    console.log(response);

                    // Formatted Address
                    var formattedAddress = response.data.results[0].formatted_address;
                    var formattedAddressOutput = `
                        <ul class = "list-group">
                            <li class = "list-group-item"> ${formattedAddress}</li>
                        </ul>
                    `;

                    // Address Components
                    var addressComponents = response.data.results[0].address_components;
                    var addressComponentsOuput = `<ul class = "list-group">`;
                    for(var i = 0; i < addressComponents.length; i++){
                        addressComponentsOuput += `
                            <li class = "list-group-item"><strong>${addressComponents[i].types[0]}</strong>: ${addressComponents[i].long_name} </li>
                        `;
                    }

                    // Formatted Address
                    var lat = response.data.results[0].geometry.location.lat;
                    var lng = response.data.results[0].geometry.location.lng;
                    var geometryOutput = `
                        <ul class = "list-group">
                            <li class = "list-group-item"> <strong>Latitude</strong>:${lat}</li>
                            <li class = "list-group-item"> <strong>Longitude</strong>:${lng}</li>
                        </ul>
                    `;

                    //Output to app
                    document.getElementById('name-address').innerHTML = destination;

                    document.getElementById('formatted-address').innerHTML = formattedAddressOutput;

                    document.getElementById('address-components').innerHTML = addressComponentsOuput;

                    //document.getElementById('geometry').innerHTML = geometryOutput;

                    addMarker({coords:{lat,lng}});
                    
                })
                .catch(function(error){
                    console.log(error);
                });
            }
        }
    }
</script>

<!-- Async script executes immediately and must be after any DOM elements used in callback. -->
<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsU1flb8aRtQ5GHugB5iH_A-ggXVR_EwA&callback=initMap&libraries=&v=weekly"
async
></script>


{%endblock%}




<!-- google api key: AIzaSyAsU1flb8aRtQ5GHugB5iH_A-ggXVR_EwA-->